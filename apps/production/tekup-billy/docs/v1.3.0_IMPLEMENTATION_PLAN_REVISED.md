# ðŸ“… v1.3.0 Implementation Plan (Revised)

**Date:** October 14, 2025  
**Status:** READY TO IMPLEMENT  
**Version:** 1.3.0 (Post-Validation Revision)  
**Timeline:** 6 weeks (30 working days)  
**Launch Date:** December 4, 2025  

---

## ðŸŽ¯ **IMPLEMENTATION OVERVIEW**

### **What Changed After Validation:**

- âŒ Removed: Webhook system (5 days saved)
- âŒ Removed: File attachments, recurring invoices, contact persons, reports (not working)
- âœ… Added: Polling sync system (1 day)
- âœ… Kept: Analytics dashboard, bulk operations, smart caching
- âœ… Kept: 3 working new endpoints (bank payments, bills, organizations)

### **Revised Scope:**

- **18 new MCP tools** (down from 24)
- **9 new database tables** (down from 14)
- **3 new Billy.dk endpoints** (bank payments, bills, organizations)
- **Polling-based sync** (every 15 minutes)

---

## ðŸ“† **WEEK-BY-WEEK BREAKDOWN**

### **Week 1: Database + Core Endpoints (Oct 21-25)**

#### **Day 1 (Oct 21): Polling Sync System**

**Goal:** Implement automatic background sync to replace webhooks

**Tasks:**
1. âœ… Deploy database schema to Supabase
2. âœ… Create Bull queue configuration
3. âœ… Implement `syncBillyData` function
4. âœ… Create `sync_billy_data` MCP tool
5. âœ… Create `get_sync_status` MCP tool
6. âœ… Setup automatic 15-minute sync job

**Files to Create/Modify:**

```
src/
  tools/
    sync.ts         # NEW: Sync MCP tools
  services/
    sync-service.ts # NEW: Sync logic
    queue.ts        # NEW: Bull queue setup
```

**Code Snippets:**

`src/services/queue.ts`:

```typescript
import Queue from 'bull';
import { getBillyConfig } from '../config';

const config = getBillyConfig();

export const syncQueue = new Queue('billy:sync-queue', config.redisUrl, {
  defaultJobOptions: {
    attempts: 3,
    backoff: { type: 'exponential', delay: 5000 },
    removeOnComplete: 100,
    removeOnFail: 200
  }
});

// Process sync jobs
syncQueue.process(async (job) => {
  const { organizationId, resourceType } = job.data;
  await syncResource(organizationId, resourceType);
});

// Schedule automatic sync every 15 minutes
export function startAutomaticSync() {
  syncQueue.add(
    'sync-all-resources',
    { resourceTypes: ['invoices', 'customers', 'products', 'bank_payments', 'bills'] },
    { repeat: { cron: '*/15 * * * *' } } // Every 15 minutes
  );
}
```

**Testing:**
- âœ… Manual sync works: `sync_billy_data(resources=['invoices'])`
- âœ… Automatic sync runs every 15 minutes
- âœ… Sync status updated in database
- âœ… Error handling works

**Success Criteria:**
- Polling sync running automatically
- Sync status tracked in `billy_sync_status` table
- 2 new MCP tools working

---

#### **Day 2-3 (Oct 22-23): Bank Payments Integration**

**Goal:** Add support for `/v2/bankPayments` endpoint

**Tasks:**
1. âœ… Add `fetchBankPayments` to Billy client
2. âœ… Create cache manager for bank payments
3. âœ… Create `list_bank_payments` MCP tool
4. âœ… Create `create_bank_payment` MCP tool
5. âœ… Add bank payments to automatic sync
6. âœ… Write tests

**Files to Create/Modify:**

```
src/
  billy-client.ts            # ADD: fetchBankPayments, createBankPayment
  tools/
    bank-payments.ts         # NEW: MCP tools
  services/
    bank-payment-service.ts  # NEW: Business logic
```

**Code Snippets:**

`src/billy-client.ts`:

```typescript
async fetchBankPayments(params: {
  organizationId: string;
  from?: string;
  to?: string;
}): Promise<BillyBankPayment[]> {
  this.logger.info('Fetching bank payments', params);
  const response = await this.request<{ bankPayments: BillyBankPayment[] }>(
    '/bankPayments',
    { params }
  );
  return response.bankPayments || [];
}
```

`src/tools/bank-payments.ts`:

```typescript
export async function listBankPayments(input: {
  organizationId: string;
  from?: string;
  to?: string;
  useCache?: boolean;
}): Promise<ToolResult> {
  const payments = await bankPaymentService.list({
    organizationId: input.organizationId,
    from: input.from,
    to: input.to,
    useCache: input.useCache !== false
  });

  return {
    content: [{
      type: 'text',
      text: JSON.stringify({ bankPayments: payments, count: payments.length }, null, 2)
    }]
  };
}
```

**Testing:**
- âœ… Can list bank payments
- âœ… Can create bank payment
- âœ… Cache works correctly
- âœ… Sync includes bank payments

**Success Criteria:**
- 2 new MCP tools working
- Bank payments cached in database
- Automatic sync includes bank payments

---

#### **Day 4-5 (Oct 24-25): Bills Management**

**Goal:** Add support for `/v2/bills` endpoint (supplier invoices)

**Tasks:**
1. âœ… Add `fetchBills`, `createBill` to Billy client
2. âœ… Create cache manager for bills
3. âœ… Create `list_bills` MCP tool
4. âœ… Create `create_bill` MCP tool
5. âœ… Add bills to automatic sync
6. âœ… Write tests

**Files to Create/Modify:**

```
src/
  billy-client.ts     # ADD: fetchBills, createBill
  tools/
    bills.ts          # NEW: MCP tools
  services/
    bill-service.ts   # NEW: Business logic
```

**Code Snippets:**

`src/tools/bills.ts`:

```typescript
export async function listBills(input: {
  organizationId: string;
  status?: 'paid' | 'unpaid' | 'overdue';
  useCache?: boolean;
}): Promise<ToolResult> {
  const bills = await billService.list({
    organizationId: input.organizationId,
    status: input.status,
    useCache: input.useCache !== false
  });

  const summary = {
    total: bills.length,
    unpaid: bills.filter(b => b.status === 'unpaid').length,
    overdue: bills.filter(b => b.status === 'overdue').length,
    totalAmount: bills.reduce((sum, b) => sum + b.amount, 0)
  };

  return {
    content: [{
      type: 'text',
      text: JSON.stringify({ bills, summary }, null, 2)
    }]
  };
}
```

**Testing:**
- âœ… Can list bills with filters
- âœ… Can create bills
- âœ… Cache works correctly
- âœ… Sync includes bills

**Success Criteria:**
- 2 new MCP tools working
- Bills cached in database
- Week 1 complete: 6 new tools total

---

### **Week 2-3: Analytics Dashboard (Oct 28 - Nov 8)**

#### **Week 2: Backend Analytics API**

**Goal:** Create analytics endpoints and real-time data

**Tasks:**
1. âœ… Create `get_analytics_summary` MCP tool
2. âœ… Create `get_revenue_trends` MCP tool
3. âœ… Create `get_customer_insights` MCP tool
4. âœ… Implement aggregation queries
5. âœ… Setup Supabase real-time subscriptions
6. âœ… Write tests

**Files to Create/Modify:**

```
src/
  tools/
    analytics.ts          # NEW: Analytics MCP tools
  services/
    analytics-service.ts  # NEW: Aggregation logic
```

**Code Snippets:**

`src/tools/analytics.ts`:

```typescript
export async function getAnalyticsSummary(input: {
  organizationId: string;
  period?: 'today' | 'week' | 'month' | 'year';
}): Promise<ToolResult> {
  const summary = await analyticsService.getSummary(
    input.organizationId,
    input.period || 'month'
  );

  return {
    content: [{
      type: 'text',
      text: JSON.stringify({
        period: input.period,
        revenue: summary.totalRevenue,
        invoices: summary.invoiceCount,
        customers: summary.customerCount,
        averageInvoiceValue: summary.avgInvoiceValue,
        outstandingPayments: summary.outstandingAmount
      }, null, 2)
    }]
  };
}
```

**Testing:**
- âœ… Analytics calculations correct
- âœ… Real-time updates work
- âœ… Performance acceptable (<500ms)

**Success Criteria:**
- 3 new analytics MCP tools working
- Real-time subscriptions active

---

#### **Week 3: Frontend Dashboard**

**Goal:** Build Next.js dashboard with Recharts visualization

**Tasks:**
1. âœ… Setup Next.js 14 project structure
2. âœ… Create dashboard layout
3. âœ… Implement revenue charts (Recharts)
4. âœ… Implement customer analytics
5. âœ… Add real-time updates (Supabase subscriptions)
6. âœ… Responsive design (mobile + desktop)

**Files to Create:**

```
dashboard/                  # NEW Next.js project
  app/
    page.tsx               # Main dashboard
    analytics/
      page.tsx             # Analytics page
  components/
    RevenueChart.tsx       # Revenue visualization
    CustomerInsights.tsx   # Customer metrics
    InvoiceTable.tsx       # Invoice list
  lib/
    supabase.ts            # Supabase client
    hooks.ts               # Custom hooks
```

**Testing:**
- âœ… Dashboard loads < 2s
- âœ… Charts render correctly
- âœ… Real-time updates work
- âœ… Mobile responsive

**Success Criteria:**
- Full analytics dashboard live
- Real-time data synchronization
- Week 2-3 complete: 9 new tools total

---

### **Week 4: Smart Caching (Nov 11-15)**

#### **Day 1-2 (Nov 11-12): Access Pattern Tracking**

**Goal:** Implement cache access logging and analysis

**Tasks:**
1. âœ… Add access count increment to cache hits
2. âœ… Log access patterns to `billy_cache_access_log`
3. âœ… Create analysis queries
4. âœ… Implement cleanup job (7-day retention)

**Files to Create/Modify:**

```
src/
  services/
    cache-tracker.ts  # NEW: Access pattern tracking
    cache-analyzer.ts # NEW: Pattern analysis
```

**Code Snippets:**

`src/services/cache-tracker.ts`:

```typescript
export async function trackCacheAccess(
  organizationId: string,
  resourceType: string,
  resourceId: string
) {
  await supabase.from('billy_cache_access_log').insert({
    organization_id: organizationId,
    resource_type: resourceType,
    resource_id: resourceId,
    accessed_at: new Date().toISOString()
  });

  await supabase.rpc('increment_cache_access_count', {
    table_name: `billy_cached_${resourceType}`,
    resource_id: resourceId
  });
}
```

**Testing:**
- âœ… Access patterns logged correctly
- âœ… Access counts increment
- âœ… Cleanup job runs successfully

---

#### **Day 3-4 (Nov 13-14): Dynamic TTL Calculation**

**Goal:** Implement rule-based TTL optimization

**Tasks:**
1. âœ… Calculate access frequency per resource
2. âœ… Implement TTL rules (high/medium/low frequency)
3. âœ… Update cache TTLs dynamically
4. âœ… Create `get_cache_performance` MCP tool

**Code Snippets:**

`src/services/cache-optimizer.ts`:

```typescript
export function calculateOptimalTTL(accessesPerHour: number): number {
  if (accessesPerHour >= 10) return 60;      // 1 hour for hot resources
  if (accessesPerHour >= 2) return 15;       // 15 min for warm resources
  if (accessesPerHour >= 0.5) return 5;      // 5 min for cool resources
  return 2;                                   // 2 min for cold resources
}
```

**Testing:**
- âœ… TTL calculation correct
- âœ… Cache hit rate improves
- âœ… Performance metrics tracked

---

#### **Day 5 (Nov 15): Cache Warming**

**Goal:** Pre-load frequently accessed resources

**Tasks:**
1. âœ… Identify hot resources (access_count > 10)
2. âœ… Create `warm_cache` MCP tool
3. âœ… Implement automatic cache warming on startup

**Testing:**
- âœ… Cache warming reduces cold starts
- âœ… Cache hit rate reaches 75-80%

**Success Criteria:**
- 2 new caching MCP tools working
- Cache hit rate improved to 75-80%
- Week 4 complete: 11 new tools total

---

### **Week 5: Bulk Operations (Nov 18-22)**

#### **Day 1-2 (Nov 18-19): CSV Import**

**Goal:** Implement bulk customer/product import

**Tasks:**
1. âœ… Setup PapaParse for CSV parsing
2. âœ… Create Zod validation schemas
3. âœ… Implement `import_customers_csv` MCP tool
4. âœ… Implement `import_products_csv` MCP tool
5. âœ… Add job progress tracking

**Code Snippets:**

`src/tools/bulk-import.ts`:

```typescript
export async function importCustomersCSV(input: {
  organizationId: string;
  csvData: string;
  continueOnError?: boolean;
}): Promise<ToolResult> {
  const jobId = `import_customers_${Date.now()}`;
  
  // Parse CSV
  const parsed = Papa.parse(input.csvData, { header: true });
  
  // Create bulk job
  await bulkService.createJob({
    jobId,
    organizationId: input.organizationId,
    resourceType: 'customer',
    operation: 'import_csv',
    totalItems: parsed.data.length
  });

  // Queue for processing
  await bulkQueue.add('import-customers', {
    jobId,
    data: parsed.data,
    continueOnError: input.continueOnError !== false
  });

  return {
    content: [{
      type: 'text',
      text: JSON.stringify({ jobId, status: 'queued', totalItems: parsed.data.length }, null, 2)
    }]
  };
}
```

**Testing:**
- âœ… CSV parsing works
- âœ… Validation catches errors
- âœ… Bulk import succeeds
- âœ… Progress tracking accurate

---

#### **Day 3-4 (Nov 20-21): CSV Export**

**Goal:** Implement bulk invoice export

**Tasks:**
1. âœ… Create `export_invoices_csv` MCP tool
2. âœ… Implement CSV generation
3. âœ… Add file storage (temp files)
4. âœ… Create download URL

**Testing:**
- âœ… CSV export works
- âœ… File download works
- âœ… Large exports handled

---

#### **Day 5 (Nov 22): Job Management**

**Goal:** Implement bulk job monitoring

**Tasks:**
1. âœ… Create `get_bulk_job_status` MCP tool
2. âœ… Create `cancel_bulk_job` MCP tool
3. âœ… Add job cleanup (30-day retention)

**Testing:**
- âœ… Job status accurate
- âœ… Cancellation works
- âœ… Cleanup runs successfully

**Success Criteria:**
- 5 new bulk operation MCP tools working
- CSV import/export functional
- Week 5 complete: 16 new tools total

---

### **Week 6: Testing + Launch (Nov 25 - Dec 4)**

#### **Day 1-2 (Nov 25-26): Integration Testing**

**Tasks:**
1. âœ… Test all 31 MCP tools end-to-end
2. âœ… Performance testing (< 100ms target)
3. âœ… Load testing (100+ concurrent users)
4. âœ… Error handling verification

**Testing Checklist:**
- [ ] All 31 tools work correctly
- [ ] Cache hit rate 75-80%
- [ ] Polling sync runs automatically
- [ ] Analytics dashboard real-time
- [ ] Bulk operations complete successfully
- [ ] Error handling graceful

---

#### **Day 3-4 (Nov 27-29): Documentation**

**Tasks:**
1. âœ… Update README.md with new tools
2. âœ… Create user guide for dashboard
3. âœ… Document bulk import CSV format
4. âœ… API reference for all tools

---

#### **Day 5 (Dec 2): Deployment**

**Tasks:**
1. âœ… Deploy to Render.com
2. âœ… Verify production environment
3. âœ… Run smoke tests
4. âœ… Monitor for 24 hours

---

#### **Day 6-7 (Dec 3-4): Buffer Days**

**Purpose:** Handle unexpected issues, final polish

---

## ðŸ“Š **FINAL DELIVERABLES**

### **MCP Tools: 31 Total**

**Existing (v1.2.0): 13 tools**
- Invoices: 4 tools
- Customers: 3 tools
- Products: 2 tools
- Revenue: 1 tool
- Test runner: 3 tools

**New (v1.3.0): 18 tools**
- Polling sync: 2 tools
- Bank payments: 2 tools
- Bills: 2 tools
- Organization settings: 2 tools (deferred to Week 3 Day 1-2 if time allows)
- Analytics: 3 tools
- Bulk operations: 5 tools
- Smart caching: 2 tools

### **Database Tables: 17 Total**

- Existing: 8 tables (from v1.2.0)
- New: 9 tables (sync, caching, bulk ops)

### **Dashboard:**

- Next.js 14 analytics dashboard
- Real-time revenue charts
- Customer insights
- Mobile responsive

---

## âœ… **SUCCESS CRITERIA**

- [x] All 18 new MCP tools working
- [ ] Cache hit rate 75-80%
- [ ] Polling sync running automatically (every 15 min)
- [ ] Analytics dashboard live with real-time updates
- [ ] Bulk CSV import/export functional
- [ ] Performance < 100ms for cached operations
- [ ] Zero critical bugs
- [ ] Documentation complete

---

## ðŸš€ **LAUNCH CHECKLIST**

### **Pre-Launch (Nov 25 - Dec 1):**

- [ ] All tests passing
- [ ] Documentation complete
- [ ] Performance metrics met
- [ ] Security audit passed
- [ ] Staging environment tested

### **Launch Day (Dec 2):**

- [ ] Deploy to production
- [ ] Verify all tools working
- [ ] Monitor for 24 hours
- [ ] Fix any critical issues

### **Post-Launch (Dec 3-4):**

- [ ] User feedback collected
- [ ] Minor bug fixes
- [ ] Performance tuning
- [ ] Celebrate! ðŸŽ‰

---

**Ready to build!** ðŸš€ Week 1 Day 1 starts October 21, 2025.
