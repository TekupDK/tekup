# Troubleshooting Authentication Issues\n\n\n\n## Error: "Client is unauthorized to retrieve access tokens"\n\n\n\nDette er den mest almindelige fejl n√•r du fors√∏ger at bruge Google APIs med en service account.\n\n### Fejlbesked\n\n\n\n```\n\nunauthorized_client: Client is unauthorized to retrieve access tokens using this method,or client not authorized for any of the scopes requested.\n\n```\n\n### √Örsager\n\n\n\n1. **Domain-wide delegation er ikke aktiveret** p√• service account\n\n2. **Scopes er ikke autoriseret** i Google Workspace Admin Console\n\n3. **Service account email er forkert** i `.env`\n\n4. **Private key er ugyldig eller forkert formateret**\n\n## L√∏sning: Step-by-Step Guide\n\n\n\n### Step 1: Verificer Service Account\n\n\n\n1. G√• til [Google Cloud Console](https://console.cloud.google.com/)\n\n2. V√¶lg dit projekt\n\n3. G√• til **IAM & Admin ‚Üí Service Accounts**\n\n4. Find din service account (f.eks. `renos@project-id.iam.gserviceaccount.com`)\n\n5. Klik p√• den og noter **Client ID** (det er et langt tal)\n\n\n\n### Step 2: Aktiv√©r Domain-Wide Delegation\n\n\n\n1. I service account oversigten, klik p√• din service account\n\n2. G√• til **Details** tab\n\n3. Under "Advanced settings" finder du **Domain-wide delegation**\n\n4. Klik **Enable G Suite Domain-wide Delegation**\n\n5. Gem √¶ndringerne\n\n### Step 3: Autoris√©r Scopes i Google Workspace Admin\n\n\n\nDette er det mest kritiske step! üîë\n\n1. G√• til [Google Admin Console](https://admin.google.com/)\n\n2. Log ind som en **Super Admin** for dit dom√¶ne\n\n3. G√• til **Security ‚Üí Access and data control ‚Üí API controls**\n\n4. Klik p√• **Manage Domain-wide Delegation**\n\n5. Klik **Add new**\n\n6. Indtast **Client ID** fra Step 1\n\n7. Indtast disse OAuth scopes (kommasepareret):\n\n```https://www.googleapis.com/auth/gmail.modify,https://www.googleapis.com/auth/calendar,https://www.googleapis.com/auth/calendar.events,https://www.googleapis.com/auth/calendar.readonly\n\n```\n\n8. Klik **Authorize**\n\n### Step 4: Verificer .env Konfiguration\n\n\n\nTjek at din `.env` fil har:\n\n```env\n\n# Service Account Email (fra Google Cloud Console)\n\nGOOGLE_CLIENT_EMAIL=renos@project-id.iam.gserviceaccount.com\n\n\n\n# Private Key (hele n√∏glen med \n for linjeskift)\n\nGOOGLE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQ...resten af n√∏glen...\n-----END PRIVATE KEY-----\n"\n\n\n\n# Den bruger du vil impersonere (skal v√¶re i dit dom√¶ne)\n\nGOOGLE_IMPERSONATED_USER=info@rendetalje.dk\n\n\n\n# Project ID fra Google Cloud\n\nGOOGLE_PROJECT_ID=your-project-id\n\n```\n\n**Vigtigt for GOOGLE_PRIVATE_KEY:**\n\n- Skal v√¶re i citationstegn\n\n- Skal have `\n` for linjeskift (ikke rigtige linjeskift)\n\n- Skal starte med `-----BEGIN PRIVATE KEY-----\n`\n\n- Skal slutte med `\n-----END PRIVATE KEY-----\n`\n\n\n\n### Step 5: Verificer Impersonated User\n\n\n\nBrugeren i `GOOGLE_IMPERSONATED_USER` skal:\n\n1. **V√¶re en rigtig bruger** i dit Google Workspace dom√¶ne\n\n2. **Have adgang** til Gmail og Calendar\n\n3. **Ikke v√¶re en gruppe eller alias**Test med en admin-bruger f√∏rst, derefter skift til den faktiske bruger.\n\n### Step 6: Vent 5-10 Minutter\n\n\n\nEfter du har autoriseret scopes i Admin Console, kan det tage op til 10 minutter f√∏r √¶ndringerne tr√¶der i kraft. Google skal propagere √¶ndringerne til deres servere.‚òï Tag en kaffepause og pr√∏v igen!\n\n### Step 7: Test Forbindelsen\n\n\n\nN√•r alt er sat op, test med:\n\n```powershellnpm run data:fetch\n\n```Du burde nu se:\n\n```üîç RenOS Data FetcherMode: DRY-RUNService: allMax Results: 10üìß Fetching Gmail messages...Found X messages:...\n\n```\n\n## Andre Almindelige Fejl\n\n\n\n### "403 Forbidden" eller "Access Denied"\n\n\n\n**√Örsag:** Service account har ikke de n√∏dvendige tilladelser.\n\n**L√∏sning:**\n\n- Verificer at scopes er autoriseret i Admin Console\n\n- Tjek at impersonated user har adgang til Gmail/Calendar\n\n- S√∏rg for at Gmail og Calendar APIs er aktiveret i Cloud Console\n\n\n\n### "404 Not Found"\n\n\n\n**√Örsag:** Calendar ID eller email adresse findes ikke.\n\n**L√∏sning:**\n\n- Tjek at `GOOGLE_IMPERSONATED_USER` er korrekt\n\n- Verificer at `SMOKETEST_CALENDAR_ID` er "primary" eller en gyldig calendar ID\n\n- Test med "primary" f√∏rst\n\n\n\n### "Invalid JWT Signature"\n\n\n\n**√Örsag:** Private key er forkert eller beskadiget.\n\n**L√∏sning:**\n\n- Download en ny service account n√∏gle fra Google Cloud Console\n\n- S√∏rg for at hele n√∏glen er kopieret korrekt\n\n- Tjek at `\n` linjeskift er korrekte\n\n\n\n### "Token has been expired or revoked"\n\n\n\n**√Örsag:** Service account n√∏glen er blevet slettet eller deaktiveret.\n\n**L√∏sning:**\n\n- G√• til Google Cloud Console ‚Üí IAM & Admin ‚Üí Service Accounts\n\n- Tjek at service account stadig er aktiv\n\n- Opret en ny n√∏gle hvis n√∏dvendigt\n\n\n\n## Test Checklist\n\n\n\nGennemg√• denne checklist:\n\n- [ ] Service account er oprettet i Google Cloud Console\n\n- [ ] Domain-wide delegation er aktiveret p√• service account\n\n- [ ] Client ID er noteret\n\n- [ ] Scopes er autoriseret i Google Admin Console\n\n- [ ] Gmail API er aktiveret i Google Cloud Console\n\n- [ ] Calendar API er aktiveret i Google Cloud Console\n\n- [ ] `.env` fil har alle GOOGLE_* variabler sat\n\n- [ ] GOOGLE_PRIVATE_KEY er korrekt formateret med `\n`\n\n- [ ] GOOGLE_IMPERSONATED_USER er en gyldig bruger i dom√¶net\n\n- [ ] Ventet 5-10 minutter efter at have autoriseret scopes\n\n- [ ] Testet med `npm run data:fetch`\n\n\n\n## Stadig Problemer?\n\n\n\nHvis du stadig har problemer efter at have fulgt denne guide:\n\n1. **Tjek logs**: K√∏r med debug logging:   ```powershell   $env:LOG_LEVEL="debug"; npm run data:fetch   ```\n\n2. **Test service account direkte**: Brug Google's officielle test v√¶rkt√∏j   ```powershell   npm run google:smoketest   ```\n\n3. **Verificer projekt ID**: Tjek at `GOOGLE_PROJECT_ID` matcher dit projekt i Cloud Console\n\n4. **Pr√∏v en ny service account**: Nogle gange hj√¶lper det at starte forfra med en ny service account\n\n5. **Kontakt support**: Hvis ingenting virker, kan der v√¶re et problem med dit Google Workspace setup\n\n## Nyttige Links\n\n\n\n- [Google Cloud Console](https://console.cloud.google.com/)\n\n- [Google Admin Console](https://admin.google.com/)\n\n- [Service Account Documentation](https://cloud.google.com/iam/docs/service-accounts)\n\n- [Domain-Wide Delegation Guide](https://developers.google.com/identity/protocols/oauth2/service-account#delegatingauthority)\n\n- [Gmail API Scopes](https://developers.google.com/gmail/api/auth/scopes)\n\n- [Calendar API Scopes](https://developers.google.com/calendar/api/auth)