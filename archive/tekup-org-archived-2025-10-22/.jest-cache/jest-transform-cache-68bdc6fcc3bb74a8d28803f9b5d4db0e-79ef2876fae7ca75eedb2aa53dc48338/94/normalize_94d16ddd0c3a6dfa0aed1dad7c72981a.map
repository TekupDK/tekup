{"version":3,"sources":["C:\\Users\\empir\\Tekup-org\\apps\\flow-api\\src\\ingestion\\normalize.ts"],"sourcesContent":["import { ParsedLeadPayload } from './types.js';\r\nimport { parse } from 'date-fns';\r\n\r\nconst DATE_FORMATS = [\r\n  'dd-MM-yy HH:mm', 'dd-MM-yyyy HH:mm', 'dd-MM-yy', 'dd-MM-yyyy', 'yyyy-MM-dd HH:mm', 'yyyy-MM-dd'\r\n];\r\n\r\nfunction normalizePhone(phone?: string): string | undefined {\r\n  if (!phone) return undefined;\r\n  const digits = phone.replace(/\\D/g, '');\r\n  if (digits.length === 8) return `+45${digits}`;\r\n  if (digits.startsWith('45') && digits.length === 10) return `+${digits}`;\r\n  if (digits.startsWith('00')) return `+${digits.substring(2)}`;\r\n  return phone.trim();\r\n}\r\n\r\nfunction tryParseDate(raw?: string): string | undefined {\r\n  if (!raw) return undefined;\r\n  for (const f of DATE_FORMATS) {\r\n    try {\r\n      const d = parse(raw, f, new Date());\r\n      if (!isNaN(d.getTime())) return d.toISOString();\r\n    } catch (_) { /* ignore */ }\r\n  }\r\n  return undefined;\r\n}\r\n\r\nexport function finalizePayload(p: ParsedLeadPayload): ParsedLeadPayload {\r\n  return {\r\n    ...p,\r\n    phone: normalizePhone(p.phone),\r\n    event_date: tryParseDate(p.event_date)\r\n  };\r\n}\r\n"],"names":["finalizePayload","DATE_FORMATS","normalizePhone","phone","undefined","digits","replace","length","startsWith","substring","trim","tryParseDate","raw","f","d","parse","Date","isNaN","getTime","toISOString","_","p","event_date"],"mappings":";;;;+BA2BgBA;;;eAAAA;;;yBA1BM;AAEtB,MAAMC,eAAe;IACnB;IAAkB;IAAoB;IAAY;IAAc;IAAoB;CACrF;AAED,SAASC,eAAeC,KAAc;IACpC,IAAI,CAACA,OAAO,OAAOC;IACnB,MAAMC,SAASF,MAAMG,OAAO,CAAC,OAAO;IACpC,IAAID,OAAOE,MAAM,KAAK,GAAG,OAAO,CAAC,GAAG,EAAEF,QAAQ;IAC9C,IAAIA,OAAOG,UAAU,CAAC,SAASH,OAAOE,MAAM,KAAK,IAAI,OAAO,CAAC,CAAC,EAAEF,QAAQ;IACxE,IAAIA,OAAOG,UAAU,CAAC,OAAO,OAAO,CAAC,CAAC,EAAEH,OAAOI,SAAS,CAAC,IAAI;IAC7D,OAAON,MAAMO,IAAI;AACnB;AAEA,SAASC,aAAaC,GAAY;IAChC,IAAI,CAACA,KAAK,OAAOR;IACjB,KAAK,MAAMS,KAAKZ,aAAc;QAC5B,IAAI;YACF,MAAMa,IAAIC,IAAAA,cAAK,EAACH,KAAKC,GAAG,IAAIG;YAC5B,IAAI,CAACC,MAAMH,EAAEI,OAAO,KAAK,OAAOJ,EAAEK,WAAW;QAC/C,EAAE,OAAOC,GAAG,CAAe;IAC7B;IACA,OAAOhB;AACT;AAEO,SAASJ,gBAAgBqB,CAAoB;IAClD,OAAO;QACL,GAAGA,CAAC;QACJlB,OAAOD,eAAemB,EAAElB,KAAK;QAC7BmB,YAAYX,aAAaU,EAAEC,UAAU;IACvC;AACF"}